# Tool í˜¸ì¶œ ì—†ì´ Agent í…ŒìŠ¤íŠ¸: ê°€ì§œ Tool ê²°ê³¼ë¥¼ ëŒ€í™” ê¸°ë¡ìœ¼ë¡œ ì£¼ì…

Agent ìƒì„± ì‹œ `messages` íŒŒë¼ë¯¸í„°ì— ê°€ì§œ ëŒ€í™” ê¸°ë¡(Tool call í¬í•¨)ì„ ì£¼ì…í•˜ì—¬ Agentê°€ ì´ì „ Tool í˜¸ì¶œì´ ìˆì—ˆë˜ ê²ƒì²˜ëŸ¼ ì¸ì‹í•˜ê²Œ í•©ë‹ˆë‹¤.

---

## Why? (ì™œ í•„ìš”í•œê°€?)

| ë¬¸ì œ ìƒí™© | ì„¤ëª… |
|----------|------|
| **Tool í…ŒìŠ¤íŠ¸ ì–´ë ¤ì›€** | ì‹¤ì œ Tool ì‹¤í–‰ì€ ì™¸ë¶€ API í˜¸ì¶œ, DB ì ‘ê·¼ ë“±ì´ í•„ìš”í•˜ì—¬ í…ŒìŠ¤íŠ¸ê°€ ë³µì¡í•¨ |
| **íŠ¹ì • ì‹œë‚˜ë¦¬ì˜¤ ì¬í˜„** | "í’ˆì ˆ", "ì˜¤ë¥˜", "íŠ¹ìˆ˜ ì¼€ì´ìŠ¤" ë“± íŠ¹ì • Tool ê²°ê³¼ì— ëŒ€í•œ Agent ë°˜ì‘ í…ŒìŠ¤íŠ¸ í•„ìš” |
| **ë¹„ìš©/ì‹œê°„ ì ˆì•½** | ë§¤ë²ˆ ì‹¤ì œ Toolì„ ì‹¤í–‰í•˜ì§€ ì•Šê³  ì›í•˜ëŠ” ê²°ê³¼ë¡œ ë¹ ë¥´ê²Œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ |

## What? (ë¬´ì—‡ì„ í•˜ëŠ”ê°€?)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  fake_history (ê°€ì§œ ëŒ€í™” ê¸°ë¡)                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ User ìš”ì²­: "ë‹ˆíŠ¸ ë°˜í’ˆí•´ì£¼ì„¸ìš”"                                 â”‚
â”‚  â€¢ Agent Tool í˜¸ì¶œ: process_return(...)                         â”‚
â”‚  â€¢ Tool ê²°ê³¼ (Mock): "âœ… ë°˜í’ˆ ì ‘ìˆ˜ ì™„ë£Œ. RT-MOCK-001"            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
                    Agent(messages=fake_history)
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AgentëŠ” fake_historyë¥¼ "ì‹¤ì œ ëŒ€í™”"ë¡œ ì¸ì‹                       â”‚
â”‚  â†’ Toolì´ ì‹¤í–‰ëœ ì  ì—†ì§€ë§Œ, ê²°ê³¼ê°€ ìˆë‹¤ê³  ë¯¿ìŒ                    â”‚
â”‚  â†’ Mock ê²°ê³¼ ê¸°ë°˜ìœ¼ë¡œ ìì—°ìŠ¤ëŸ¬ìš´ í›„ì† ì‘ë‹µ ìƒì„±                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## How? (ì–´ë–»ê²Œ ë™ì‘í•˜ëŠ”ê°€?)

1. **fake_history êµ¬ì„±**: User ìš”ì²­ â†’ Assistant toolUse â†’ toolResult ìˆœì„œë¡œ ë©”ì‹œì§€ ë°°ì—´ ìƒì„±
2. **Agent ìƒì„±**: `Agent(messages=fake_history)`ë¡œ ê³¼ê±° ëŒ€í™” ì£¼ì…
3. **í›„ì† ë©”ì‹œì§€ ì „ì†¡**: `agent("ë„¤ ì•Œê² ìŠµë‹ˆë‹¤")` í˜¸ì¶œ
4. **LLM ì²˜ë¦¬**: fake_history + ìƒˆ ë©”ì‹œì§€ë¥¼ í•˜ë‚˜ì˜ ì»¨í…ìŠ¤íŠ¸ë¡œ ì¸ì‹
5. **ì‘ë‹µ ìƒì„±**: Mock Tool ê²°ê³¼ë¥¼ ì°¸ì¡°í•˜ì—¬ ìì—°ìŠ¤ëŸ¬ìš´ ì‘ë‹µ ìƒì„±

---

## ì‹¤í–‰ ë°©ë²•

```bash
cd /home/ubuntu/ec-customer-support-e2e-agentcore
uv run under_development/messages_injection/test_messages_injection.py
```

## ì‹¤í–‰ ê²°ê³¼

```
Tool í˜¸ì¶œ ì—†ì´ Agent í…ŒìŠ¤íŠ¸: ê°€ì§œ Tool ê²°ê³¼ë¥¼ ëŒ€í™” ê¸°ë¡ìœ¼ë¡œ ì£¼ì…
==================================================

ğŸ“– ì‹œë‚˜ë¦¬ì˜¤: ë°˜í’ˆ Tool ê²°ê³¼ ì£¼ì… í…ŒìŠ¤íŠ¸
======================================================================

ğŸ“ fake_history êµ¬ì¡°:
----------------------------------------------------------------------

    fake_history = [
        # [1] User â†’ Agent
        {"role": "user",
         "content": [{"text": "ì£¼ë¬¸ë²ˆí˜¸ KS-2024-001234 ë‹ˆíŠ¸ ë°˜í’ˆí•´ì£¼ì„¸ìš”"}]},

        # [3] LLM â†’ Agent (text + toolUse)
        {"role": "assistant",
         "content": [
            {"text": "ë°˜í’ˆ ì²˜ë¦¬ ì§„í–‰í•©ë‹ˆë‹¤."},
            {"toolUse": {"toolUseId": "mock_001", "name": "process_return",
                        "input": {"order_number": "...", "item_name": "ë‹ˆíŠ¸"}}}
        ]},

        # [5] Tool â†’ Agent (toolResult)
        {"role": "user",
         "content": [
            {"toolResult": {"toolUseId": "mock_001", "status": "success",
                           "content": [{"text": "âœ… ë°˜í’ˆ ì ‘ìˆ˜ ì™„ë£Œ. RT-MOCK-001"}]}}
        ]}
    ]

----------------------------------------------------------------------

ğŸ“Š Trace Diagram:
======================================================================
    User              Agent              LLM               Tool
======================================================================

[1] User â†’ Agent: ê³ ê° ìš”ì²­ (fake_history[0])
    â”‚
    â”‚  "ì£¼ë¬¸ë²ˆí˜¸ KS-2024-001234 ë‹ˆíŠ¸ ë°˜í’ˆí•´ì£¼ì„¸ìš”"
    â”‚
    â–¼
----------------------------------------------------------------------

[2] Agent â†’ LLM: ë©”ì‹œì§€ ì „ë‹¬
                  â”‚
                  â”‚  messages + tools ì •ë³´
                  â”‚
                  â–¼
----------------------------------------------------------------------

[3] LLM â†’ Agent: Tool í˜¸ì¶œ ê²°ì • (fake_history[1])
                  â”‚
                  â”‚  text: "ë°˜í’ˆ ì²˜ë¦¬ ì§„í–‰í•©ë‹ˆë‹¤."
                  â”‚  toolUse: process_return(...)
                  â”‚
                  â–¼
----------------------------------------------------------------------

[4] Agent â†’ Tool: Tool ì‹¤í–‰
                                          â”‚
                                          â”‚  process_return()
                                          â”‚
                                          â–¼
----------------------------------------------------------------------

[5] Tool â†’ Agent: ê²°ê³¼ ë°˜í™˜ (fake_history[2])
                                          â”‚
                  â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                  â”‚
                  â”‚  "âœ… ë°˜í’ˆ ì ‘ìˆ˜ ì™„ë£Œ. RT-MOCK-001, 59,000ì›"
                  â”‚
----------------------------------------------------------------------

======================================================================
    â†‘â†‘â†‘ ì—¬ê¸°ê¹Œì§€ fake_historyë¡œ ì£¼ì… (ì‹¤ì œ ì‹¤í–‰ X) â†‘â†‘â†‘
======================================================================
    â†“â†“â†“ ì—¬ê¸°ì„œë¶€í„° ì‹¤ì œ ì‹¤í–‰ â†“â†“â†“
======================================================================

[6] User â†’ Agent: í›„ì† ë©”ì‹œì§€ (ì‹¤ì œ)
    â”‚
    â”‚  "ë„¤ ì•Œê² ìŠµë‹ˆë‹¤"
    â”‚
    â–¼
----------------------------------------------------------------------

[7] Agent â†’ LLM: API í˜¸ì¶œ (ì‹¤ì œ)
                  â”‚
                  â”‚  fake_history + ìƒˆ ë©”ì‹œì§€
                  â”‚
                  â–¼
----------------------------------------------------------------------

[8] LLM â†’ Agent: ì‘ë‹µ ìƒì„±
                  â”‚
                  â–¼
----------------------------------------------------------------------

[9] Agent â†’ User: ìµœì¢… ì‘ë‹µ ì „ë‹¬
----------------------------------------------------------------------

ğŸ‘¤ User Input: "ë„¤ ì•Œê² ìŠµë‹ˆë‹¤"
   â””â”€â–¶ agent("ë„¤ ì•Œê² ìŠµë‹ˆë‹¤") í˜¸ì¶œ
       â””â”€â–¶ fake_history + ìƒˆ ë©”ì‹œì§€ë¥¼ LLMì— ì „ì†¡

ğŸ¤– Agent Response (ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°):
========================================
ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ˜Š

**ë°˜í’ˆ ì ‘ìˆ˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.**

ğŸ“‹ **ë°˜í’ˆ ì •ë³´**
- ì ‘ìˆ˜ë²ˆí˜¸: RT-MOCK-001
- í™˜ë¶ˆ ì˜ˆì •ì•¡: 59,000ì›
- ì£¼ë¬¸ë²ˆí˜¸: KS-2024-001234

ğŸ“¦ **ë‹¤ìŒ ë‹¨ê³„ ì•ˆë‚´**
1. íƒë°° ê¸°ì‚¬ë‹˜ì´ 1-2ì¼ ë‚´ ë°©ë¬¸í•˜ì—¬ ìƒí’ˆì„ ìˆ˜ê±°í•´ ê°‘ë‹ˆë‹¤
2. ìƒí’ˆ í™•ì¸ í›„ 2-3ì¼ ë‚´ í™˜ë¶ˆ ì²˜ë¦¬ë©ë‹ˆë‹¤
3. í™˜ë¶ˆì€ ê²°ì œí•˜ì‹  ë°©ë²•ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤

ë‹¤ë¥¸ ë„ì›€ì´ í•„ìš”í•˜ì‹  ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“ ì§€ ë§ì”€í•´ ì£¼ì„¸ìš”! ğŸ™

========================================

----------------------------------------------------------------------

ğŸ“Š ê²°ê³¼ ë¶„ì„
======================================================================

â€¢ [1]~[5]: fake_historyë¡œ ì£¼ì…ë¨ (Tool ì‹¤í–‰ ì—†ìŒ)
â€¢ [6]~[8]: ì‹¤ì œ API í˜¸ì¶œ ë°œìƒ
â€¢ LLMì€ fake_historyë¥¼ ì‹¤ì œ ëŒ€í™”ë¡œ ì¸ì‹
â€¢ Mock ë°ì´í„°(RT-MOCK-001, 59,000ì›)ë¥¼ ì°¸ì¡°í•˜ì—¬ ì‘ë‹µ ìƒì„±
----------------------------------------------------------------------
```

## í•µì‹¬ í¬ì¸íŠ¸

1. **fake_history êµ¬ì¡°**: `messages` íŒŒë¼ë¯¸í„°ë¡œ ê³¼ê±° ëŒ€í™” ê¸°ë¡ ì£¼ì…
2. **toolUseId ì¼ì¹˜**: `toolUse`ì™€ `toolResult`ì˜ IDê°€ ë°˜ë“œì‹œ ì¼ì¹˜í•´ì•¼ í•¨
3. **role ê·œì¹™**: `toolResult`ëŠ” `role: "user"`ë¡œ ì „ë‹¬ (Bedrock API ê·œì•½)
4. **ì‹¤ì œ Tool ë¯¸ì‹¤í–‰**: [1]~[5]ëŠ” ì£¼ì…ëœ ë°ì´í„°, ì‹¤ì œ Tool í˜¸ì¶œ ì—†ìŒ
5. **LLM ì¸ì‹**: LLMì€ fake_historyë¥¼ ì‹¤ì œ ëŒ€í™”ë¡œ ì¸ì‹í•˜ê³  ì‘ë‹µ ìƒì„±

## Agent ìƒì„± â†’ LLM API ìš”ì²­ ë§¤í•‘

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Agent ìƒì„± ì‹œ                              LLM API ìš”ì²­ ì‹œ (ì‹¤ì œ ì „ì†¡)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    fake_history = [                          {
      {role: "user", ...},                      "system": SYSTEM_PROMPT,
      {role: "assistant",
       content: [text, toolUse]},               "tools": [              â† Agentê°€ ë³€í™˜
      {role: "user", toolResult}                  {name: "process_return",
    ]                                              description: "...",
                                                   input_schema: {...}},
    Agent(                             â”€â”€â–¶       {name: "process_exchange", ...},
      model=model,                               {name: "web_search", ...}
      tools=[                                   ],
        process_return,
        process_exchange,                       "messages": [            â† fake_history
        web_search                                {role: "user", ...},
      ],                                          {role: "assistant",
      system_prompt=SYSTEM_PROMPT,                 content: [..., toolUse]},
      messages=fake_history  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶       {role: "user", toolResult}
    )                                           ]
                                              }

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### ì„¤ëª…

| ë‹¨ê³„ | ë™ì‘ | ì„¤ëª… |
|------|------|------|
| 1 | `fake_history` ì •ì˜ | Tool í˜¸ì¶œ/ê²°ê³¼ë¥¼ í¬í•¨í•œ ê°€ì§œ ëŒ€í™” ê¸°ë¡ ìƒì„± |
| 2 | `Agent()` ìƒì„± | `messages=fake_history`ë¡œ ê³¼ê±° ëŒ€í™” ì£¼ì… |
| 3 | `agent("ìƒˆ ë©”ì‹œì§€")` í˜¸ì¶œ | Agentê°€ LLM API ìš”ì²­ êµ¬ì„± |
| 4 | LLM API ì „ì†¡ | `system` + `tools` + `messages`(fake_history í¬í•¨) ì „ì†¡ |
| 5 | LLM ì‘ë‹µ | LLMì€ fake_historyë¥¼ ì‹¤ì œ ëŒ€í™”ë¡œ ì¸ì‹í•˜ê³  ì‘ë‹µ ìƒì„± |

**í•µì‹¬:**
- `tools` ë°°ì—´: Agentê°€ Python í•¨ìˆ˜ë¥¼ JSON ìŠ¤í‚¤ë§ˆë¡œ ë³€í™˜í•˜ì—¬ ì „ì†¡
- `messages` ë°°ì—´: `fake_history`ê°€ ê·¸ëŒ€ë¡œ ì „ë‹¬ë˜ì–´ LLMì´ ê³¼ê±° ëŒ€í™”ë¡œ ì¸ì‹
- LLMì€ Toolì´ ì‹¤ì œë¡œ ì‹¤í–‰ë˜ì—ˆëŠ”ì§€ ì•Œ ìˆ˜ ì—†ìŒ â†’ Mock ê²°ê³¼ë¥¼ ì‹¤ì œ ê²°ê³¼ë¡œ ì·¨ê¸‰
